// This is your Prisma schema file
// Learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String          @id @default(cuid())
  clerkId           String          @unique
  email             String          @unique
  name              String?
  firstName         String?
  lastName          String?
  imageUrl          String?
  role              String          @default("free") // free, premium, admin
  isBlocked         Boolean         @default(false)
  blockedAt         DateTime?
  blockedReason     String?
  blockedBy         String?         // Admin user ID who blocked
  ayrshareProfileKey String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  // Relations
  socialAccounts    SocialAccount[]
  posts             Post[]
  campaigns         Campaign[]
  subscription      Subscription?
  analytics         Analytics[]
  apiKeys           ApiKey[]
  platformIntegrations PlatformIntegration[]
   notifications     Notification[]  // ADD THIS LINE
  
  @@map("users")
}

// ADD THIS ENTIRE MODEL
model Notification {
  id        String   @id @default(cuid())
  userId    String
  message   String
  type      String   @default("in-app") // in-app, email, push
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("notifications")
}

model Plan {
  id                    String          @id @default(cuid())
  name                  String          @unique
  price                 Float           // USD monthly
  priceNGN              Float?          // NGN monthly
  priceGBP              Float?          // GBP monthly
  yearlyMonthlyPrice    Float?          // USD monthly when billed yearly
  yearlyMonthlyPriceNGN Float?
  yearlyMonthlyPriceGBP Float?
  currency              String          @default("USD")
  description           String?
  features              String[]
  maxPosts              Int             @default(10) // -1 = unlimited
  maxPlatforms          Int             @default(3)  // -1 = unlimited
  maxWhatsAppMessages   Int             @default(0)
  stripePriceId         String?
  trialDays             Int             @default(7)
  sortOrder             Int             @default(0)  // Display order on pricing page
  isActive              Boolean         @default(true)
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  // Relations
  payments      Payment[]
  subscriptions Subscription[]

  @@map("plans")
}

model Payment {
  id                String          @id @default(cuid())
  userId            String
  planId            String?
  reference         String          @unique  // Transaction reference
  amount            Float           // amount in USD
  currency          String          @default("USD") // Currency code
  status            String          // 'pending', 'success', 'failed'
  stripeSessionId   String?         // Stripe Checkout Session ID
  stripePaymentIntentId String?     // Stripe Payment Intent ID
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  // Relations
  plan              Plan?           @relation(fields: [planId], references: [id])

  @@index([userId])
  @@index([reference])
  @@map("payments")
}

model Subscription {
  id                      String          @id @default(cuid())
  userId                  String          @unique
  planId                  String
  planType                String          // Starter, Creator, Agency
  status                  String          // trial, active, inactive, cancelled, past_due
  currentPeriodStart      DateTime
  currentPeriodEnd        DateTime
  trialEndsAt             DateTime?       // When the trial period ends
  cancelAtPeriodEnd       Boolean         @default(false)
  stripeCustomerId        String?         // Stripe Customer ID / Paystack customer_code
  stripeSubscriptionId    String?         // Stripe Subscription ID / Paystack subscription_code
  paystackAuthCode        String?         // Paystack authorization code for recurring charges
  cardLast4               String?         // Last 4 digits of card
  cardBrand               String?         // Card brand (Visa, Mastercard, etc.)
  cardExpMonth            String?         // Card expiry month
  cardExpYear             String?         // Card expiry year
  nextBillingDate         DateTime?       // Next billing date
  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt

  // Relations
  user                    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan                    Plan            @relation(fields: [planId], references: [id])

  @@map("subscriptions")
}

model SocialAccount {
  id                String          @id @default(cuid())
  userId            String
  platform          String          // facebook, twitter, instagram, tiktok, linkedin, whatsapp, youtube
  accountId         String?         // platform-specific account ID
  username          String
  displayName       String
  profilePicture    String?
  accessToken       String
  refreshToken      String?
  tokenExpiry       DateTime?
  isActive          Boolean         @default(true)
  lastSync          DateTime?
  followerCount     Int?
  phoneNumber       String?         // For WhatsApp Business API
  businessAccountId String?         // For WhatsApp/Facebook Business
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  // Relations
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  posts             Post[]
  postResults       PostResult[]

  @@unique([userId, platform])
  @@unique([userId, platform, accountId])
  @@map("social_accounts")
}

model PlatformIntegration {
  id                String          @id @default(cuid())
  userId            String
  platform          String          // 'facebook', 'twitter', 'instagram', 'linkedin', 'youtube', 'tiktok', 'whatsapp'
  platformUserId    String          // Platform-specific user ID
  accountName       String          // Display name or username on the platform
  accessToken       String
  refreshToken      String?
  expiresAt         DateTime?
  isConnected       Boolean         @default(true) // Updated from isActive to isConnected
  profileUrl        String?         // URL to the user's profile on the platform
  profileImageUrl   String?         // URL to the user's profile image
  connectedAt       DateTime        @default(now()) // When the integration was first connected
  metadata          Json?           // Store platform-specific data (WhatsApp: phoneNumberId, businessAccountId)
  isActive          Boolean         @default(true)
  phoneNumber       String?         // For WhatsApp Business
  businessAccountId String?         // For WhatsApp/Facebook Business
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  // Relations
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, platform])
  @@map("platform_integrations")
}

model Campaign {
  id             String          @id @default(cuid())
  userId         String
  name           String
  title          String?
  description    String?
  budget         Float?
  targetAudience String?
  objectives     String[]
  platforms      String[]
  startDate      DateTime?
  endDate        DateTime?
  contentType    String?
  hashtags       String[]        @default([])
  isActive       Boolean         @default(true)
  status         CampaignStatus  @default(DRAFT) // Changed from String to CampaignStatus
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  
  // Relations
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  posts          Post[]
  
  @@index([userId])
  @@map("campaigns")
}

model Post {
  id                String          @id @default(cuid())
  userId            String
  content           String
  imageUrl          String?
  videoUrl          String?
  mediaUrls         String[]        @default([]) // Array of media URLs (added field)
  scheduledFor      DateTime?
  scheduledAt       DateTime?       // Alternative field name for scheduling (added field)
  status            PostStatus      @default(DRAFT)
  campaignId        String?
  hashtags          String[]        @default([])
  platforms         String[]        @default([]) // array of platform names
  metadata          Json?           // Store platform-specific post data
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  publishedAt       DateTime?
  
  // Relations
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  campaign          Campaign?       @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  socialAccounts    SocialAccount[]
  postResults       PostResult[]
  analytics         PostAnalytics[]
  legacyAnalytics   Analytics[]     // Keep legacy analytics for backward compatibility
  
  @@map("posts")
}

model PostResult {
  id                String          @id @default(cuid())
  postId            String
  socialAccountId   String
  externalId        String?         // ID from the social platform
  status            PublishStatus   @default(PENDING)
  error             String?
  publishedAt       DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  // Relations
  post              Post            @relation(fields: [postId], references: [id], onDelete: Cascade)
  socialAccount     SocialAccount   @relation(fields: [socialAccountId], references: [id], onDelete: Cascade)
  
  @@unique([postId, socialAccountId])
  @@map("post_results")
}

model PostAnalytics {
  id                String          @id @default(cuid())
  postId            String
  platform          String
  impressions       Int             @default(0)
  engagements       Int             @default(0)
  likes             Int             @default(0)
  comments          Int             @default(0)
  shares            Int             @default(0)
  clicks            Int             @default(0)
  reach             Int             @default(0)
  saves             Int             @default(0)
  recordedAt        DateTime        @default(now())
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  // Relations
  post              Post            @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  @@unique([postId, platform, recordedAt])
  @@map("post_analytics")
}

model Analytics {
  id          String          @id @default(cuid())
  userId      String
  postId      String?
  platform    String
  metric      String          // likes, shares, comments, views, reach, impressions
  value       Int
  date        DateTime        @default(now())
  createdAt   DateTime        @default(now())

  // Relations
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  post        Post?           @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@map("analytics")
}

model ScheduledTask {
  id                String          @id @default(cuid())
  type              TaskType
  payload           Json
  scheduledFor      DateTime
  status            TaskStatus      @default(PENDING)
  attempts          Int             @default(0)
  maxAttempts       Int             @default(3)
  lastAttempt       DateTime?
  error             String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  @@map("scheduled_tasks")
}

model ApiKey {
  id                String          @id @default(cuid())
  userId            String
  name              String
  key               String          @unique
  permissions       String[]        @default([])
  isActive          Boolean         @default(true)
  lastUsed          DateTime?
  expiresAt         DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  // Relations
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("api_keys")
}

model AuditLog {
  id                String          @id @default(cuid())
  userId            String?
  action            String
  resource          String
  resourceId        String?
  details           Json?
  ipAddress         String?
  userAgent         String?
  createdAt         DateTime        @default(now())
  
  @@map("audit_logs")
}

model BlogPost {
  id          String          @id @default(cuid())
  title       String
  slug        String          @unique
  excerpt     String
  content     String
  category    String
  readTime    String
  published   Boolean         @default(false)
  featured    Boolean         @default(false)
  imageUrl    String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@map("blog_posts")
}

model WaitlistUser {
  id        String          @id @default(cuid())
  email     String          @unique
  firstName String?
  lastName  String?
  createdAt DateTime        @default(now())

  @@map("waitlist_users")
}

model DemoVideo {
  id          String          @id @default(cuid())
  title       String
  description String?
  youtubeUrl  String          // YouTube video URL or embed ID
  thumbnailUrl String?
  isActive    Boolean         @default(true)
  order       Int             @default(0) // For ordering multiple videos
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@map("demo_videos")
}

model DemoRequest {
  id              String          @id @default(cuid())
  name            String
  email           String
  phone           String?
  company         String?
  preferredDate   DateTime?
  preferredTime   String?
  message         String?
  status          String          @default("pending") // pending, scheduled, completed, cancelled
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@map("demo_requests")
}

enum PostStatus {
  DRAFT
  SCHEDULED
  PUBLISHED
  FAILED
  CANCELLED
}

enum PublishStatus {
  PENDING
  PUBLISHED
  FAILED
  CANCELLED
}

enum TaskType {
  PUBLISH_POST
  REFRESH_TOKEN
  FETCH_ANALYTICS
  CLEANUP_EXPIRED_TOKENS
}

enum TaskStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  COMPLETED
  PAUSED
}